# DevSpace + ArgoCD Development Workflow

This document describes how to use DevSpace for local development while ArgoCD manages deployments in your Kubernetes cluster.

## Architecture Overview

- **ArgoCD**: Manages all Kubernetes deployments from the `dist/` directory (GitOps)
- **DevSpace**: Provides local development experience by attaching to ArgoCD-managed pods
- **Kargo**: Handles progressive deployment through stages (dev → staging → prod)

## Prerequisites

1. ArgoCD is deployed and managing your applications
2. Your NextJS application is running in the `nextjs` namespace
3. DevSpace is installed locally

## Development Workflow

### 1. Start Development Mode

```bash
# Start DevSpace development mode
devspace dev

# This will:
# - Wait for ArgoCD-managed pods to be ready
# - Replace the container with a dev-optimized image
# - Set up file synchronization
# - Forward ports for local access
# - Open a terminal in the container
```

### 2. Check ArgoCD Status

```bash
# Check if ArgoCD app is synced
devspace run argocd-status

# Refresh ArgoCD (if needed)
devspace run argocd-refresh
```

### 3. Development Best Practices

#### Option A: Work with ArgoCD Auto-Sync (Recommended)
- Make code changes locally
- Changes sync to the container via DevSpace
- Test changes in real-time
- When ready, commit changes and push
- GitHub Actions will synthesize CDK8s and update `dist/`
- ArgoCD will automatically deploy changes

#### Option B: Disable Auto-Sync During Development
```bash
# Disable auto-sync
devspace run argocd-disable-sync

# Do your development work...

# Re-enable auto-sync when done
devspace run argocd-enable-sync
```

### 4. Handling Configuration Changes

When you need to change Kubernetes resources:

1. Modify the CDK8s code (not in this repo based on your setup)
2. Push changes to trigger GitHub Actions
3. Wait for synthesis to complete
4. ArgoCD will pick up changes from `dist/`

## Important Notes

1. **Never manually edit files in `dist/`** - These are generated by CDK8s
2. **DevSpace doesn't create deployments** - It only attaches to existing ArgoCD-managed pods
3. **Container replacement is temporary** - Restarting the pod will restore the original image

## Troubleshooting

### Pod Not Found
If DevSpace can't find the pod:
```bash
# Check if deployment exists
kubectl get deploy -n nextjs

# Check ArgoCD application status
kubectl get app cdk8s-applications -n argocd
```

### Sync Issues
If changes aren't reflected:
```bash
# Hard refresh ArgoCD
devspace run argocd-refresh

# Check sync status
devspace run argocd-status
```

### Development Container Issues
If the dev container isn't working properly:
```bash
# Exit DevSpace (Ctrl+C)
# Delete the pod to force recreation
kubectl delete pod -n nextjs -l app=nextjs

# Restart DevSpace
devspace dev
```

## Integration with Kargo

Your Kargo pipeline automatically promotes images through stages:
- New images trigger promotions in the `dev` stage
- Successful dev deployments can be promoted to `staging`
- Staging can be promoted to `prod`

DevSpace development doesn't interfere with this process since it only temporarily replaces containers for development.